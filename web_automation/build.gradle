group 'web_automation'
version '1.0-SNAPSHOT'
import java.io.*
import groovy.json.*


buildscript {
    repositories {
        jcenter()
        mavenCentral()
    }
    dependencies {
        classpath "ru.d10xa:gradle-allure-plugin:0.5.5"
    }
}

apply plugin: 'java'
apply plugin: 'idea'
apply plugin: 'ru.d10xa.allure'

sourceCompatibility = JavaVersion.VERSION_1_8
targetCompatibility = JavaVersion.VERSION_1_8

repositories {
    mavenCentral()
}

dependencies {
    compile group: 'io.appium', name: 'java-client', version: '6.1.0'
    compile group: 'javax.mail', name: 'mail', version: '1.4.5'
    compile group: 'org.testcontainers', name: 'selenium', version: '1.4.3'
    compile group: 'io.github.bonigarcia', name: 'webdrivermanager', version: '1.7.2'
    compile group: 'ru.yandex.qatools.htmlelements', name: 'htmlelements-java', version: '1.18'
    compile group: 'ru.yandex.qatools.allure', name:'allure-cucumber-jvm-adaptor', version:'1.6.4'
    compile group: 'info.cukes', name: 'cucumber-java8', version: '1.2.5'
    compile group: 'info.cukes', name: 'cucumber-testng', version: '1.2.4'
    compile group: 'com.github.kirlionik', name: 'allure-cucumber-plugin', version: '1.0.3'
    compile group: 'io.rest-assured', name: 'rest-assured', version: '3.0.2'
    compile group: 'com.github.javafaker', name: 'javafaker', version: '0.14'
    compile group: 'org.twitter4j', name: 'twitter4j-core', version: '4.0.1'
    compile 'mysql:mysql-connector-java:5.1.+'
    compile group: 'com.paulhammant', name: 'ngwebdriver', version: '1.1.3'
}

configurations {
    compile
}

allure{
    aspectjweaver = true
    testNG = false
    allureResultsDir = "$buildDir${File.separator}allure-results"
    allureReportDir = "$buildDir${File.separator}allure-report"
}

def baseXmlPath = "/src/test/resources/"
def tenantName = "generalbank"
def suite="all"
def touchGoPlan = "unknown"
def env = 'testing'

// ========= !! SERVICE TASKS !! ============== //

task getTouchGoPlan() {
    def localTenantName // Created for handling cases when tenant name contains "-". Like "virgin-money".
    if (System.getProperty("env") != null){
        env=System.getProperty("env")
    }
    if (System.getProperty("tenant") != null) {
        tenantName = System.properties.getProperty("tenant")
    }
    localTenantName=tenantName
    if(localTenantName.contains("_")) localTenantName = localTenantName.replace("_", "-")
    def uri = 'https://'+env+'-touch.clickatelllabs.com/internal/tenants/'+ localTenantName +'/config/'
    def headers = [ Accept: 'application/json' ]
    try {
        def jsonText = new URL(uri).getText(requestProperties: headers)
        def parsedJson = new JsonSlurper().parseText(jsonText) as Map
        touchGoPlan = parsedJson.get('touchGoType')
    } catch(IOException e){
        touchGoPlan = "started"
    }
}

tasks.withType(Test) {
    systemProperties = System.getProperties()
}

// ========= !! TASKS FOR SUITES !! ============== //

task runFacebookTests(type:Test) {
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath + tenantName + "/facebook.xml"
    }
}

task runTwitterTests(type:Test) {
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath + tenantName + "/twitter.xml"
    }
}

task runBaseTests(type:Test) {
    useTestNG() {
        println("base TEST ENV " + System.getProperty("env"))
        useDefaultListeners = true
        ignoreFailures = true
        suites baseXmlPath+tenantName+"/mastercheck.xml"
    }
    reports.html.enabled = false
}

task runTieTests(type:Test) {
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath+tenantName+"/tie.xml"
    }
}

task runVisibilityTests(type:Test) {
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath+tenantName+"/visibilitytests.xml"
    }
}

task runTouchTests(type:Test) {
    runTouchTests.dependsOn(getTouchGoPlan)
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath+tenantName+"/uitests.xml"
        suites baseXmlPath+tenantName+"/onethreadtests.xml"
        suites baseXmlPath+tenantName+"/"+touchGoPlan.toLowerCase()+".xml"
    }
}

task runTouchPullRequestTests(type:Test) {

//    runTouchTests.dependsOn(getTouchGoPlan)
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath+tenantName+"/widget_pullrequest.xml"
        suites baseXmlPath+tenantName+"/onethreadtests_pullrequest.xml"
//        suites baseXmlPath+tenantName+"/"+touchGoPlan.toLowerCase()+".xml"
    }
}

task runAllTests(type:Test){
    doFirst {
        runTieTests.execute()
        runBaseTests.execute()
    }
    doLast {
        if (!(file("build/reports/tests/runBaseTests/testng-failed.xml").exists())) {
            runTouchTests.execute()
        }
        if (file("build/reports/tests/runBaseTests/testng-failed.xml").exists()) {
            String failedTestXMLContent = file("build/reports/tests/runBaseTests/testng-failed.xml").text
            if (!failedTestXMLContent.contains("Failed suite [General Bank Master check]")) {
                runTouchTests.execute()
            }
        }
        runVisibilityTests.execute()
    }
}

task runPullRequestTests(type:Test){
    doFirst {
        runTiePullRequestTests.execute()
        runBaseTests.execute()
    }
    doLast {
        if (!(file("build/reports/tests/runBaseTests/testng-failed.xml").exists())) {
            runTouchPullRequestTests.execute()
        }
        if (file("build/reports/tests/runBaseTests/testng-failed.xml").exists()) {
            String failedTestXMLContent = file("build/reports/tests/runBaseTests/testng-failed.xml").text
            if (!failedTestXMLContent.contains("Failed suite [General Bank Master check]")) {
                runTouchPullRequestTests.execute()
            }
        }
        runVisibilityTests.execute()
    }
}

task runTiePullRequestTests(type:Test) {
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath+tenantName+"/tiepullrequest.xml"
    }
}

task runTouchVirginMoneyTests(type:Test){
    doFirst {
        useTestNG() {
            ignoreFailures = true
            suites baseXmlPath+tenantName+"/uitests.xml"
            suites baseXmlPath+tenantName+"/onethreadtests.xml"
            suites baseXmlPath+tenantName+"/"+touchGoPlan.toLowerCase()+".xml"
        }
    }
}
task runTouchGenBankTests(type:Test){
    doFirst {
        useTestNG() {
            ignoreFailures = true
            suites baseXmlPath+tenantName+"/uitests.xml"
            suites baseXmlPath+tenantName+"/onethreadtests.xml"
            suites baseXmlPath+tenantName+"/"+touchGoPlan.toLowerCase()+".xml"
        }
    }
}

task runFAQsTests(type:Test){
    doFirst {
        useTestNG() {
            ignoreFailures = true
            suites baseXmlPath+tenantName+"/faqs.xml"
        }
    }
}

task runTIETestsForAllTenants(type: Test) {
    doFirst {
        useTestNG() {
            ignoreFailures = true
            suites baseXmlPath + "generalbank/tie.xml"
            suites baseXmlPath + "virgin_money/tie.xml"
        }
    }
}

task runTestsAgainstNewlyCreatedAccount(type:Test){
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath + "touchgo/touchgofornewaccount.xml"
    }
}

task runTouchGoTests(type:Test) {
    runTouchTests.dependsOn(getTouchGoPlan)
    doFirst {
        useTestNG() {
            useDefaultListeners = true
            ignoreFailures = true
            suites baseXmlPath+ "touchgo/createfbintegration.xml"
            suites baseXmlPath + "touchgo/onethreadtouchgotests.xml"
            suites baseXmlPath+ "touchgo/paralleltouchgotests.xml"
        }
    }
    doLast {
        if (!file("build/reports/tests/runTouchGoTests/testng-failed.xml").exists()) {
            runTestsAgainstNewlyCreatedAccount.execute()
        } else {
            String failedTestXMLContent = file("build/reports/tests/runTouchGoTests/testng-failed.xml").text
            if (!failedTestXMLContent.contains("Touch Go create new account test(failed)")) {
                runTestsAgainstNewlyCreatedAccount.execute()
            }

        }
    }
}

task runHealthCheckTests(type:Test) {
    useTestNG() {
        useDefaultListeners = true
        ignoreFailures = true
        suites baseXmlPath+"/healthcheck.xml"
    }
    reports.html.enabled = false
}

task runDotControlTests(type:Test) {
    useTestNG() {
        useDefaultListeners = true
        ignoreFailures = true
        suites baseXmlPath+"/dotcontrol/dotcontrol.xml"
    }
    reports.html.enabled = false
}

task runCamundaFlowsTests(type:Test) {
    useTestNG() {
        useDefaultListeners = true
        ignoreFailures = true
        suites baseXmlPath+"/camundaflows/camundaflows.xml"
    }
    reports.html.enabled = false
}


task runChatdeskTests(type:Test) {
    runTouchTests.dependsOn(getTouchGoPlan)
    useTestNG() {
        ignoreFailures = true
        suites baseXmlPath+tenantName+"/onethreadtests.xml"
        suites baseXmlPath+tenantName+"/"+touchGoPlan.toLowerCase()+".xml"
    }
}

// ========= !! MAIN TASKS !! ============== //

task runTests(type: Test) {

    if (System.getProperty("tenant") != null) {
        tenantName = System.properties.getProperty("tenant")
    }
    if (System.getProperty("suite") != null) {
        suite = System.properties.getProperty("suite")
    }

    if(suite == "facebook") {
        runTests.dependsOn(runFacebookTests)
    }

    if(suite == "twitter") {
        runTests.dependsOn(runTwitterTests)
    }

    if(suite == "basecheck") {
        runTests.dependsOn(runBaseTests)
    }

    if(suite == "tie") {
        runTests.dependsOn(runTieTests)
    }

    if(suite=="visibility"){
        runTests.dependsOn(runVisibilityTests)
    }

    if(suite=="all") {
        runTests.dependsOn(runAllTests)
    }

    if(suite=="pullrequest") {
        runTests.dependsOn(runPullRequestTests)
    }

    if(suite=="faqs") {
        runTests.dependsOn(runFAQsTests)
    }

    if(suite=="tiepullrequest"){
        runTests.dependsOn(runTiePullRequestTests)
    }

    if(suite=="tiealltenants"){
        runTests.dependsOn(runTIETestsForAllTenants)
    }

    if(suite=="touchgo"){
        runTests.dependsOn(runTouchGoTests)
    }

    if(suite == "healthcheck") {
        runTests.dependsOn(runHealthCheckTests)
    }

    if(suite == "dotcontrol"){
        runTests.dependsOn(runDotControlTests)
    }

    if(suite == "camundaflows"){
        runTests.dependsOn(runCamundaFlowsTests)
    }

    if(suite == "chatdesk"){
        runTests.dependsOn(runChatdeskTests)
    }

    runTests.finalizedBy(allureReport)
    defaultTasks 'clean', 'runTests'
}

task runTestsForAllTenants(type: Test) {
    runTestsForAllTenants.dependsOn 'clean'
    classes.mustRunAfter 'clean'

    systemProperties = System.getProperties()
    doFirst {
        useTestNG() {
            useDefaultListeners = true
            ignoreFailures = true
            suites baseXmlPath + "generalbank/mastercheck.xml"
            suites baseXmlPath + "virgin_money/mastercheck.xml"
            suites baseXmlPath + "generalbank/tie.xml"
            suites baseXmlPath + "virgin_money/tie.xml"
        }
        reports.html.enabled = false
//        System.out.print("\n!!! ++ reports.html.enabled = false + !!!\n")
    }
    doLast {
        if (!file("build/reports/tests/runTestsForAllTenants/Virgin Money Master check/testng-failed.xml").exists()){
            tenantName="virgin_money"
            runTouchVirginMoneyTests.execute()
        }
        if (!file("build/reports/tests/runTestsForAllTenants/General Bank Master check/testng-failed.xml").exists()){
            tenantName="generalbank"
            runTouchGenBankTests.execute()
        }
        runVisibilityTests.execute()
        runCamundaFlowsTests.execute()
        runDotControlTests.execute()
    }
    runTestsForAllTenants.finalizedBy(allureReport)
}
