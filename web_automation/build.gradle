group 'web_authomation'
version '1.0-SNAPSHOT'

buildscript {
    repositories {
        jcenter()
        mavenCentral()
    }
    dependencies {
        classpath "ru.d10xa:gradle-allure-plugin:0.5.5"
        classpath "com.avast.gradle:gradle-docker-compose-plugin:0.6.10"
    }
}

apply plugin: 'java'
apply plugin: 'idea'
apply plugin: 'ru.d10xa.allure'

sourceCompatibility = JavaVersion.VERSION_1_8
targetCompatibility = JavaVersion.VERSION_1_8

repositories {
    mavenCentral()
}

dependencies {
//    compile group: 'org.postgresql', name: 'postgresql', version: '42.1.1'
    compile group: 'io.appium', name: 'java-client', version: '5.0.4'
    compile group: 'org.testcontainers', name: 'selenium', version: '1.4.3'
    compile group: 'io.github.bonigarcia', name: 'webdrivermanager', version: '1.7.2'
//    compile group: 'org.seleniumhq.selenium', name: 'selenium-java', version: '3.7.1'
    compile group: 'ru.yandex.qatools.htmlelements', name: 'htmlelements-java', version: '1.18'
    compile group: 'ru.yandex.qatools.allure', name:'allure-cucumber-jvm-adaptor', version:'1.6.4'
    compile group: 'info.cukes', name: 'cucumber-java8', version: '1.2.5'
    // was 1.2.5
    compile group: 'info.cukes', name: 'cucumber-testng', version: '1.2.4'
    compile group: 'com.github.kirlionik', name: 'allure-cucumber-plugin', version: '1.0.2'
    compile group: 'io.rest-assured', name: 'rest-assured', version: '3.0.2'
    compile group: 'com.github.javafaker', name: 'javafaker', version: '0.14'
}

configurations {
    compile
}

allure{
    aspectjweaver = true
    testNG = false
    allureResultsDir = "$buildDir${File.separator}allure-results"
    allureReportDir = "$buildDir${File.separator}allure-report"
}


test(){
println 'acceptance test'
    useTestNG(){
        useDefaultListeners = true
        ignoreFailures = true
        suites "/src/test/resources/tie.xml"
        suites '/src/test/resources/mastercheck.xml'

    }


    reports.html.enabled = false
    if(System.getProperty("env") != null){
        systemProperty "env",System.getProperty("env")
    }

    if(System.getProperty("browser") != null){
        systemProperty "browser",System.getProperty("browser")
    }

    if(System.getProperty("remote") != null){
        systemProperty "remote", System.properties.getProperty("remote")
    }

    if(System.getProperty("cucumber.options") != null){
        systemProperty "cucumber.options", System.properties.getProperty("cucumber.options")
    }


    defaultTasks 'clean', 'test'
}

task runUITest(type:Test) {

    println "!! UI TESTS"
       dependsOn test
    
       if (!(file("build/reports/tests/testng-failed.xml").exists())) {
           System.out.print("!!! " + "no testng file" + " !!!")
           useTestNG() {
               ignoreFailures = true
               suites '/src/test/resources/uitests.xml'
           }
//       } else {
//           String xml = file("build/reports/tests/testng-failed.xml").collect(Collectors.joining("\n"))
//           System.out.print("!!! " + xml + " !!!")
//           if (!(xml.contains("Master check") && xml.contains("feature"))) {
//               useTestNG() {
//                   ignoreFailures = true
//                   suites '/src/test/resources/uitests.xml'
//               }
//           }
       }
   }

    task allTests(dependsOn: tasks.withType(Test)) {
        test.finalizedBy(allureReport)
    }

